<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Загрузка прошивки</title>
    <!-- Подключение Bootstrap для стилизации -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">Загрузка прошивки</h1>
        <!-- Форма загрузки прошивки -->
        <form method="post" enctype="multipart/form-data" class="row g-3" id="firmwareForm">
            {% csrf_token %}
            <div class="col-12">
                <!-- Поле для ввода IP-адреса устройства -->
                <label for="id_ip_address" class="form-label">IP адрес устройства</label>
                <input type="text" name="ip_address" class="form-control" id="id_ip_address" required
                    pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                    title="Введите корректный IPv4 адрес, например: 192.168.1.1">
            </div>
            <div class="col-12">
                <!-- Зона для drag & drop и выбора файла -->
                <label for="id_firmware_file" class="form-label">Файл прошивки</label>
                <div id="dropZone" class="border border-primary rounded p-4 text-center mb-2 bg-light"
                    style="cursor:pointer;">
                    <span id="dropText">Перетащите файл .npk сюда или выберите вручную</span>
                    <!-- Скрытое поле выбора файла, открывается по клику на dropZone -->
                    <input type="file" name="firmware_file" class="form-control mt-2" id="id_firmware_file" required
                        accept=".npk" style="display:none;">
                </div>
            </div>
            <div class="col-12">
                <!-- Кнопка отправки формы -->
                <button type="submit" class="btn btn-primary">Загрузить</button>
            </div>
        </form>
        <!-- Всплывающее сообщение об успехе или ошибке -->
        {% if message %}
        <div class="alert alert-{{ message_type }} alert-dismissible fade show position-fixed top-0 end-0 m-3"
            role="alert" style="z-index:1055; min-width:300px;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
        </div>
        {% endif %}
    </div>
    <!-- Подключение Bootstrap JS для работы алертов -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
    <script>
        // Получаем элементы формы и drop-зоны
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('id_firmware_file');
        const dropText = document.getElementById('dropText');
        const MAX_SIZE = 20 * 1024 * 1024; // Максимальный размер файла: 20 МБ

        // Открытие диалога выбора файла по клику на drop-зону
        dropZone.addEventListener('click', () => fileInput.click());

        // Визуальное приглашение при перетаскивании файла
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-success', 'bg-white');
            dropZone.classList.remove('border-primary', 'bg-light');
            dropText.textContent = 'Отпустите файл для загрузки';
        });

        // Возврат к исходному виду, если файл не был отпущен
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-success', 'bg-white');
            dropZone.classList.add('border-primary', 'bg-light');
            dropText.textContent = 'Перетащите файл .npk сюда или выберите вручную';
        });

        // Обработка drop: проверка расширения и размера файла
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-success', 'bg-white');
            dropZone.classList.add('border-primary', 'bg-light');
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (!file.name.toLowerCase().endsWith('.npk')) {
                    dropText.innerHTML = `<span class="text-danger">Файл должен иметь расширение .npk</span>`;
                    fileInput.value = ""; // сброс выбранного файла
                    return;
                }
                fileInput.files = e.dataTransfer.files;
                showFileInfo(file);
            }
        });

        // Обработка выбора файла через стандартный диалог
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                showFileInfo(fileInput.files[0]);
            } else {
                dropText.textContent = 'Перетащите файл .npk сюда или выберите вручную';
            }
        });

        // Функция для отображения информации о выбранном файле
        function showFileInfo(file) {
            // Проверка расширения
            if (!file.name.toLowerCase().endsWith('.npk')) {
                dropText.innerHTML = `<span class="text-danger">Файл должен иметь расширение .npk</span>`;
            } 
            // Проверка размера
            else if (file.size > MAX_SIZE) {
                dropText.innerHTML = `<span class="text-danger">Файл слишком большой (&gt; 20 МБ)</span>`;
            } 
            // Если всё ок, показываем имя файла
            else {
                dropText.innerHTML = `<span class="text-success">${file.name}</span>`;
            }
        }
    </script>
</body>

</html>